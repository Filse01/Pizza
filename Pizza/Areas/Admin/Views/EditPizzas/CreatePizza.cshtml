@using EditPizzaViewModel = Pizza.ViewModels.EditPizzaViewModel
@using EditPageViewModel = Pizza.ViewModels.EditPageViewModel
@model EditPageViewModel

<style>
    /* Custom Styles for Polish */
    
    /* 1. Smooth Card */
    .pizza-card {
        border: none;
        border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    
    .card-header-custom {
        background: linear-gradient(45deg, #ff6b6b, #ee5253);
        color: white;
        padding: 1.5rem;
    }

    /* 2. Autocomplete Dropdown Styling */
    .search-container {
        position: relative;
    }

    .result-box {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        background: white;
        border-radius: 0 0 0.5rem 0.5rem;
        box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        max-height: 200px;
        overflow-y: auto;
        display: none; /* Hidden by default */
    }

    .result-box ul {
        list-style: none;
        padding: 0;
        margin: 0;
        border: 1px solid #dee2e6;
        border-top: none;
    }

    .result-box li {
        padding: 10px 15px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid #f1f1f1;
    }

    .result-box li:hover {
        background-color: #f8f9fa;
        color: #ee5253;
        font-weight: 600;
    }

    /* 3. Ingredient Chips with Delete Animation */
    .ingredients-box {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        min-height: 50px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        border: 1px dashed #dee2e6;
    }

    .ingredient-chip {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 1rem;
        background-color: #e9ecef;
        color: #495057;
        border-radius: 50rem; /* Pill shape */
        font-weight: 500;
        cursor: pointer;
        user-select: none;
        transition: all 0.3s ease;
        overflow: hidden;
        border: 1px solid transparent;
    }

    /* Text inside the chip */
    .ingredient-chip span {
        transition: opacity 0.2s ease;
    }

    /* The Hidden X Icon */
    .ingredient-chip .delete-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 0;
        color: white;
        transition: all 0.2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    /* Hover State: Turn Red, Hide Text, Show X */
    .ingredient-chip:hover {
        background-color: #dc3545; /* Bootstrap Danger */
        box-shadow: 0 4px 6px rgba(220, 53, 69, 0.3);
        padding-right: 1rem; /* Maintain shape */
    }

    .ingredient-chip:hover span {
        opacity: 0; /* Fade out text */
    }

    .ingredient-chip:hover .delete-icon {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.2); /* Pop in */
    }
</style>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <form asp-controller="EditPizzas" asp-action="CreatePizza">
                <div class="card pizza-card">
                    <div class="card-header-custom">
                        <h3 class="mb-0"><i class="fas fa-pizza-slice me-2"></i>Create Pizza</h3>
                    </div>

                    <div class="card-body p-4">
                        <h5 class="text-muted mb-3">Basic Information</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input asp-for="Pizza.Name" class="form-control" placeholder="Pizza Name"/>
                                    <label asp-for="Pizza.Name">Pizza Name</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input asp-for="Pizza.Price" class="form-control" type="number" step="0.01" placeholder="Price"/>
                                    <label asp-for="Pizza.Price">Price ($)</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <input asp-for="Pizza.ImageUrl" class="form-control" placeholder="Image URL"/>
                                    <label asp-for="Pizza.ImageUrl">Image URL</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea asp-for="Pizza.Description" class="form-control" style="height: 100px" placeholder="Description"></textarea>
                                    <label asp-for="Pizza.Description">Description</label>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <h5 class="text-muted mb-3">Manage Ingredients</h5>

                        <div class="search-container mb-3">
                            <label class="form-label small text-secondary">Add New Ingredient</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                                <input type="text" id="input-box" class="form-control" placeholder="Search for ingredients..." autocomplete="off">
                                <button class="btn btn-primary addIngredient px-4" type="button">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                            <div class="result-box"></div>
                        </div>

                        <label class="form-label small text-secondary">Current Ingredients (Hover to remove)</label>
                        <div class="ingredients-box" id="ingredients-container">
                            
                        </div>
                    </div>

                    <div class="card-footer bg-white p-4 text-end">
                        <a href="javascript:history.back()" class="btn btn-light me-2">Cancel</a>
                        <button type="submit" class="btn btn-success px-4">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // 1. Data Setup
    let availableIngredients = [
        @foreach (var ing in Model.Ingredients)
        {
            <text>{id: "@ing.Id", name: "@ing.Name"},</text>
        }
    ];

    // 2. Element Selectors
    const resultBox = document.querySelector(".result-box");
    const inputBox = document.querySelector("#input-box");
    const addIngButton = document.querySelector(".addIngredient");
    const ingredientsBox = document.querySelector(".ingredients-box");
    const emptyMsg = document.querySelector(".empty-msg");

    // Initialize existing chips
    const existingChips = document.querySelectorAll(".ingredient-chip");
    existingChips.forEach(chip => addIngEventListener(chip));

    // 3. Search Logic
    inputBox.onkeyup = function () {
        let input = inputBox.value;
        if (input.length > 0) {
            let result = availableIngredients.filter((i) => {
                return i.name.toLowerCase().includes(input.toLowerCase());
            });
            display(result);
        } else {
            resultBox.style.display = "none";
        }
    }

    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!inputBox.contains(e.target) && !resultBox.contains(e.target)) {
            resultBox.style.display = "none";
        }
    });

    function display(result) {
        if(result.length === 0) {
            resultBox.innerHTML = "";
            resultBox.style.display = "none";
            return;
        }

        const content = result.map((list) => {
            // Escaping quotes for safety
            const safeName = list.name.replace(/'/g, "\\'"); 
            return `<li onclick="selectedInput('${safeName}')">${list.name}</li>`;
        });
        
        resultBox.innerHTML = "<ul>" + content.join("") + "</ul>";
        resultBox.style.display = "block";
    }

    function selectedInput(name) {
        inputBox.value = name;
        resultBox.innerHTML = "";
        resultBox.style.display = "none";
    }

    // 4. Add Ingredient Logic
    addIngButton.addEventListener("click", async function (e) {
        e.preventDefault();
        e.stopPropagation();

        if (inputBox.value.trim() !== "") {
            // Find ID based on name
            let ingredientObj = availableIngredients.find(({name}) => name.toLowerCase() === inputBox.value.toLowerCase());
            
            if(!ingredientObj) {
                alert("Please select a valid ingredient from the list.");
                return;
            }

            // Check if already added to prevent duplicates visually
            if(document.getElementById(ingredientObj.id)) {
                inputBox.value = "";
                return;
            }

            try {
                // Create UI Element (Chip style)
                const chip = document.createElement("div");
                chip.classList.add("ingredient-chip");
                chip.id = ingredientObj.id;
                
                // Inner HTML structure for animation
                const index = ingredientObj.id;

                chip.innerHTML = `
    <span>${ingredientObj.name}</span>
    <i class="fas fa-times delete-icon"></i>

    <input type="hidden" name="Ingredients.Index" value="${index}" />

    <input type="hidden" name="Ingredients[${index}].Id" value="${ingredientObj.id}" />
    <input type="hidden" name="Ingredients[${index}].Name" value="${ingredientObj.name}" />
`;

                // Handle Empty State Message
                if(emptyMsg) emptyMsg.style.display = 'none';

                ingredientsBox.appendChild(chip);
                addIngEventListener(chip); // Attach delete listener
                
                // Clear Input
                inputBox.value = "";

            } catch (err) {
                console.error("Failed to add ingredient", err);
            }
        }
    });

    // 5. Remove Ingredient Logic
    function addIngEventListener(chip){
        chip.addEventListener("click", async function(){
            let ingId = chip.id;
            let pizzaId = window.location.href.split("/").pop();
            
            let params = new URLSearchParams({
                ingId: ingId,
                pizzaId: pizzaId
            });

            try {
                // API Call
                await fetch(`@Url.Action("RemoveIngredient", "EditPizzas")?${params.toString()}`, {method: "POST"});
                
                // Animation: Scale down before removing
                chip.style.transform = "scale(0)";
                chip.style.opacity = "0";
                
                setTimeout(() => {
                    chip.remove();
                    // Check if empty to show message again
                    if(ingredientsBox.children.length === 0 || (ingredientsBox.children.length === 1 && ingredientsBox.contains(emptyMsg))) {
                         if(emptyMsg) emptyMsg.style.display = 'block';
                    }
                }, 300);

            } catch (err) {
                console.error("Failed to remove ingredient", err);
            }
        })
    }
</script>
